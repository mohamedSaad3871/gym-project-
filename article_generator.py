import os
import json
from openai import OpenAI
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Initialize OpenAI client
api_key = os.getenv("OPENAI_API_KEY")

# Check if API key is set and valid
if not api_key or api_key == "your_openai_api_key_here":
    print("Warning: OpenAI API key is not set or is using default value. AI features will not work.")

# Initialize client even if key is invalid (will handle errors later)
client = OpenAI(api_key=api_key)

def generate_ai_article(topic, subtopic=None, language="ar"):
    """
    Generate a personalized article using OpenAI API
    
    Args:
        topic (str): Main topic (muscle_gain, fat_loss, etc.)
        subtopic (str, optional): Specific subtopic if any
        language (str): Language for the response (default: Arabic)
    
    Returns:
        dict: Article data
    """
    # Check if API key is valid
    if not api_key or api_key == "your_openai_api_key_here":
        # Return a default article if no valid API key
        print("Using default article generator - API key not configured")
        return generate_default_article(topic, subtopic)
        
    try:
        # Convert parameters to Arabic for better context
        topic_ar = {
            'muscle_gain': 'بناء العضلات',
            'fat_loss': 'حرق الدهون',
            'weight_loss': 'إنقاص الوزن',
            'diet': 'النظام الغذائي',
            'home_workout': 'تمارين منزلية',
            'fitness': 'اللياقة البدنية',
            'nutrition': 'التغذية',
            'supplements': 'المكملات الغذائية',
            'cardio': 'تمارين القلب',
            'strength': 'تمارين القوة'
        }.get(topic, topic)
        
        # Create prompt for OpenAI
        prompt = f"""
        اكتب مقالاً مفصلاً ومفيداً عن {topic_ar}
        
        يجب أن يتضمن المقال:
        1. مقدمة تشرح أهمية الموضوع
        2. معلومات علمية موثوقة مدعمة بالأبحاث
        3. نصائح عملية يمكن تطبيقها
        4. أمثلة توضيحية
        5. خاتمة تلخص النقاط الرئيسية
        
        قم بتنسيق المقال بشكل جيد مع عناوين رئيسية وفرعية.
        استخدم لغة سهلة وواضحة مناسبة للقراء المهتمين باللياقة البدنية.
        """
        
        if subtopic:
            subtopic_ar = subtopic  # You can add translation if needed
            prompt += f"\nركز بشكل خاص على {subtopic_ar} كجزء من الموضوع الرئيسي."
        
        # Call OpenAI API
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "أنت خبير في اللياقة البدنية والتغذية. تقدم معلومات دقيقة ومفيدة بأسلوب سهل وجذاب."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=2000
        )
        
        # Parse the response
        article_text = response.choices[0].message.content.strip()
        
        # Extract title from the article (usually the first line)
        lines = article_text.split('\n')
        title = lines[0].strip('#').strip() if lines else "مقال عن " + topic_ar
        
        # Remove the title from the content if it exists
        content = article_text
        if lines:
            content = '\n'.join(lines[1:]).strip()
        
        # Create article data
        article_data = {
            "title": title,
            "content": content,
            "topic": topic,
            "subtopic": subtopic
        }
                
        return article_data
            
    except Exception as e:
        print(f"Error generating article: {str(e)}")
        # Return default article on error
        return generate_default_article(topic, subtopic)

def generate_default_article(topic, subtopic=None):
    """Generate a default article when API is not available"""
    
    # Basic articles based on topics
    articles = {
        'muscle_gain': {
            'title': 'دليل شامل لبناء العضلات',
            'content': """
# دليل شامل لبناء العضلات

## مقدمة
بناء العضلات هو عملية تتطلب الالتزام والصبر والمعرفة. في هذا المقال، سنستعرض أهم المبادئ والاستراتيجيات التي تساعدك على تحقيق أهدافك في بناء كتلة عضلية قوية وصحية.

## أساسيات بناء العضلات
لبناء العضلات بشكل فعال، يجب التركيز على ثلاثة عناصر أساسية:

1. **التدريب المناسب**: يجب أن تتضمن تمارينك تمارين المقاومة التي تستهدف مجموعات عضلية مختلفة. التدريب بالأوزان الثقيلة مع عدد تكرارات متوسط (8-12 تكرار) يعتبر الأمثل لبناء العضلات.

2. **التغذية السليمة**: العضلات تحتاج إلى العناصر الغذائية المناسبة للنمو. تأكد من تناول كمية كافية من البروتين (1.6-2.2 جرام لكل كيلوجرام من وزن الجسم) والكربوهيدرات والدهون الصحية.

3. **الراحة والاستشفاء**: العضلات تنمو خلال فترات الراحة، ليس أثناء التمرين. تأكد من الحصول على 7-9 ساعات من النوم يومياً وأخذ أيام راحة كافية بين التمارين.

## برنامج تدريبي مقترح
إليك برنامج تدريبي أساسي لبناء العضلات:

- **اليوم 1**: تمارين الصدر والترايسبس
- **اليوم 2**: تمارين الظهر والبايسبس
- **اليوم 3**: راحة
- **اليوم 4**: تمارين الأكتاف والبطن
- **اليوم 5**: تمارين الأرجل
- **اليوم 6-7**: راحة

## نصائح غذائية
- تناول وجبة غنية بالبروتين والكربوهيدرات بعد التمرين مباشرة
- قسم السعرات الحرارية اليومية على 5-6 وجبات صغيرة
- اشرب كمية كافية من الماء (3-4 لتر يومياً)
- تناول الأطعمة الكاملة غير المصنعة قدر الإمكان

## الخلاصة
بناء العضلات هو رحلة طويلة تتطلب الالتزام والصبر. ركز على التدريب المناسب، والتغذية السليمة، والراحة الكافية، وستبدأ في رؤية النتائج تدريجياً.
            """
        },
        'fat_loss': {
            'title': 'استراتيجيات فعالة لحرق الدهون',
            'content': """
# استراتيجيات فعالة لحرق الدهون

## مقدمة
حرق الدهون وتخفيف نسبة الدهون في الجسم هو هدف شائع للكثيرين. في هذا المقال، سنتناول أفضل الاستراتيجيات المبنية على العلم لمساعدتك في حرق الدهون بشكل فعال وصحي.

## مبادئ حرق الدهون
لحرق الدهون بشكل فعال، يجب فهم المبادئ الأساسية:

1. **العجز السعري**: لحرق الدهون، يجب أن تستهلك سعرات حرارية أقل مما يحرقه جسمك. عجز معتدل (300-500 سعرة يومياً) يعتبر مثالياً للحفاظ على العضلات.

2. **التمارين الرياضية**: مزيج من تمارين المقاومة والتمارين الهوائية يعتبر الأفضل لحرق الدهون. تمارين المقاومة تحافظ على الكتلة العضلية، بينما التمارين الهوائية تزيد من حرق السعرات.

3. **التغذية المناسبة**: تناول كمية كافية من البروتين (1.8-2.2 جرام لكل كيلوجرام من وزن الجسم) للحفاظ على العضلات، وتقليل الكربوهيدرات المكررة والسكريات.

## تمارين فعالة لحرق الدهون
- **تمارين HIIT**: تمارين عالية الكثافة متقطعة تساعد على حرق السعرات حتى بعد انتهاء التمرين
- **تمارين المقاومة**: تساعد في بناء العضلات وزيادة معدل الأيض
- **تمارين هوائية معتدلة**: المشي السريع، الجري، السباحة، ركوب الدراجات

## نصائح غذائية
- تناول الأطعمة الغنية بالألياف التي تساعد على الشعور بالشبع
- شرب الماء بكثرة، خاصة قبل الوجبات
- تقليل استهلاك السكريات المضافة والدهون المشبعة
- تناول البروتين في كل وجبة للحفاظ على الكتلة العضلية

## الخلاصة
حرق الدهون يتطلب نهجاً شاملاً يتضمن التغذية السليمة، والتمارين المناسبة، ونمط حياة صحي. التزم بالخطة، وكن صبوراً، والنتائج ستأتي تدريجياً.
            """
        },
        'home_workout': {
            'title': 'دليل التمارين المنزلية الفعالة',
            'content': """
# دليل التمارين المنزلية الفعالة

## مقدمة
التمارين المنزلية توفر بديلاً رائعاً للصالات الرياضية، خاصة عندما يكون الوقت محدوداً أو الوصول للصالة غير متاح. في هذا المقال، سنستعرض برنامجاً فعالاً للتمارين المنزلية يمكن أداؤه بدون معدات أو بمعدات بسيطة.

## فوائد التمارين المنزلية
- توفير الوقت والمال
- المرونة في اختيار وقت التمرين
- الخصوصية والراحة
- عدم الحاجة لمعدات كثيرة
- مناسبة لجميع مستويات اللياقة البدنية

## تمارين منزلية فعالة بدون معدات
### تمارين الجزء العلوي:
1. **تمارين الضغط**: 3-4 مجموعات × 10-15 تكرار
2. **تمارين الديبس**: 3 مجموعات × 10-12 تكرار
3. **تمارين الانبطاح المائل**: 3 مجموعات × 30-60 ثانية

### تمارين الجزء السفلي:
1. **تمارين القرفصاء**: 4 مجموعات × 15-20 تكرار
2. **تمارين الطعن**: 3 مجموعات × 12 تكرار لكل ساق
3. **تمارين الجسر**: 3 مجموعات × 15 تكرار

### تمارين القلب:
1. **تمارين القفز**: 4 مجموعات × 30 ثانية عمل، 30 ثانية راحة
2. **الركض في المكان**: 3 مجموعات × 1 دقيقة
3. **تمارين البيربي**: 3 مجموعات × 10 تكرار

## برنامج أسبوعي مقترح
- **اليوم 1**: تمارين الجسم كامل
- **اليوم 2**: تمارين القلب
- **اليوم 3**: راحة
- **اليوم 4**: تمارين الجزء العلوي
- **اليوم 5**: تمارين الجزء السفلي
- **اليوم 6**: تمارين القلب
- **اليوم 7**: راحة

## نصائح لتمارين منزلية فعالة
- حدد مساحة مناسبة في المنزل للتمرين
- التزم بجدول زمني منتظم
- استخدم تطبيقات اللياقة البدنية للتوجيه والتحفيز
- قم بتنويع التمارين لتجنب الملل
- تدرج في زيادة شدة التمارين مع تحسن مستوى لياقتك

## الخلاصة
التمارين المنزلية يمكن أن تكون فعالة تماماً مثل تمارين الصالة الرياضية إذا تم أداؤها بشكل صحيح وبانتظام. ابدأ ببرنامج بسيط وقم بتطويره تدريجياً مع تحسن مستوى لياقتك البدنية.
            """
        },
        'nutrition': {
            'title': 'أساسيات التغذية السليمة للرياضيين',
            'content': """
# أساسيات التغذية السليمة للرياضيين

## مقدمة
التغذية السليمة تعتبر عنصراً أساسياً في تحقيق أهدافك الرياضية، سواء كانت بناء العضلات، أو حرق الدهون، أو تحسين الأداء الرياضي. في هذا المقال، سنستعرض المبادئ الأساسية للتغذية الرياضية وكيفية تطبيقها في حياتك اليومية.

## العناصر الغذائية الأساسية

### البروتين
- **الأهمية**: ضروري لبناء وإصلاح الأنسجة العضلية
- **المصادر**: اللحوم، الدواجن، الأسماك، البيض، منتجات الألبان، البقوليات
- **الكمية الموصى بها**: 1.6-2.2 جرام لكل كيلوجرام من وزن الجسم يومياً للرياضيين

### الكربوهيدرات
- **الأهمية**: المصدر الرئيسي للطاقة للتمارين عالية الكثافة
- **المصادر**: الحبوب الكاملة، البطاطا، الفواكه، الخضروات
- **الكمية الموصى بها**: 3-7 جرام لكل كيلوجرام من وزن الجسم يومياً، اعتماداً على مستوى النشاط

### الدهون
- **الأهمية**: ضرورية لامتصاص الفيتامينات وإنتاج الهرمونات
- **المصادر**: زيت الزيتون، المكسرات، الأفوكادو، الأسماك الدهنية
- **الكمية الموصى بها**: 0.5-1 جرام لكل كيلوجرام من وزن الجسم يومياً

## توقيت الوجبات

### قبل التمرين
تناول وجبة متوازنة قبل التمرين بـ 2-3 ساعات، تحتوي على:
- كربوهيدرات سهلة الهضم
- بروتين متوسط
- دهون قليلة

### بعد التمرين
تناول وجبة خلال 30-60 دقيقة بعد التمرين، تحتوي على:
- كربوهيدرات لتجديد مخزون الجليكوجين
- بروتين عالي الجودة لإصلاح العضلات
- سوائل لتعويض ما فقد من الماء

## الترطيب
- اشرب 3-4 لتر من الماء يومياً
- زد الكمية في الأيام الحارة أو عند ممارسة التمارين لفترات طويلة
- راقب لون البول للتأكد من مستوى الترطيب (يجب أن يكون فاتح اللون)

## المكملات الغذائية
المكملات ليست بديلاً عن الغذاء الصحي، لكن بعضها قد يكون مفيداً:
- **بروتين مصل اللبن**: يساعد في بناء العضلات والاستشفاء
- **الكرياتين**: يحسن القوة والأداء في تمارين المقاومة
- **أحماض أوميغا 3 الدهنية**: تقلل الالتهابات وتدعم صحة القلب
- **فيتامين D**: ضروري لصحة العظام وقد يؤثر على الأداء الرياضي

## الخلاصة
التغذية السليمة هي أساس النجاح في تحقيق أهدافك الرياضية. ركز على تناول أطعمة كاملة غير مصنعة، واحرص على التوازن بين العناصر الغذائية، والاهتمام بتوقيت الوجبات والترطيب المناسب.
            """
        }
    }
    
    # Get article for the selected topic or return a generic one
    article = articles.get(topic, {
        'title': 'معلومات مفيدة عن اللياقة البدنية',
        'content': """
# معلومات مفيدة عن اللياقة البدنية

## مقدمة
اللياقة البدنية هي حالة من الصحة والعافية الجسدية التي تمكنك من أداء الأنشطة اليومية بنشاط وحيوية، دون تعب مفرط. في هذا المقال، سنستعرض أهم المعلومات والنصائح لتحسين لياقتك البدنية بشكل عام.

## عناصر اللياقة البدنية
تتكون اللياقة البدنية من عدة عناصر أساسية:

1. **القوة العضلية**: قدرة العضلات على توليد القوة للتغلب على المقاومة
2. **التحمل العضلي**: قدرة العضلات على الاستمرار في العمل لفترات طويلة
3. **اللياقة القلبية التنفسية**: كفاءة القلب والرئتين في توصيل الأكسجين للعضلات
4. **المرونة**: قدرة المفاصل على الحركة بحرية في نطاق حركتها الكامل
5. **التوازن والتناسق**: القدرة على التحكم في حركات الجسم

## فوائد اللياقة البدنية
- تحسين صحة القلب والأوعية الدموية
- تقوية العضلات والعظام
- تحسين المزاج والصحة النفسية
- زيادة مستويات الطاقة
- تحسين جودة النوم
- تقليل خطر الإصابة بالأمراض المزمنة

## نصائح لتحسين اللياقة البدنية
- ممارسة النشاط البدني بانتظام (150 دقيقة على الأقل أسبوعياً)
- تنويع التمارين لتشمل جميع عناصر اللياقة البدنية
- البدء تدريجياً وزيادة الشدة مع الوقت
- الالتزام بالتغذية السليمة
- الحصول على قسط كافٍ من الراحة والنوم
- شرب كمية كافية من الماء

## الخلاصة
تحسين اللياقة البدنية هو رحلة مستمرة تتطلب الالتزام والصبر. ابدأ بخطوات صغيرة، وحدد أهدافاً واقعية، واستمتع بالعملية، وستلاحظ تحسناً تدريجياً في صحتك ولياقتك البدنية.
        """
    })
    
    # Add topic and subtopic to the article data
    article_data = {
        "title": article['title'],
        "content": article['content'],
        "topic": topic,
        "subtopic": subtopic
    }
    
    return article_data
